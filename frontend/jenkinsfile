pipeline {
  agent any

  environment {
    DOCKER_IMAGE = "tapashranjannandi/expense-tracker-frontend"
    DOCKER_TAG   = "${BUILD_NUMBER}"
    GITOPS_REPO  = "https://github.com/TAPASHRANJANNANDI/expense-tracker-fullstack-deployment.git"
  }

  stages {

    stage('Checkout Application Repo') {
      steps {
        git branch: 'master',
            url: 'https://github.com/TAPASHRANJANNANDI/expense-tracker_fullstack.git'
      }
    }

    stage('Build Docker Image') {
      steps {
        sh '''
          set -e
          docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
          docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
        '''
      }
    }

    stage('Push Docker Image') {
      steps {
        script {
          docker.withRegistry('https://index.docker.io/v1/', 'docker-cred') {
            docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}").push()
            docker.image("${DOCKER_IMAGE}:latest").push()
          }
        }
      }
    }

    stage('Update GitOps Repo (Stable / Canary)') {
      steps {
        withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
          sh '''
            set -e

            rm -rf gitops
            git clone https://${GITHUB_TOKEN}@github.com/TAPASHRANJANNANDI/expense-tracker-fullstack-deployment.git gitops
            cd gitops

            if [ "${BUILD_NUMBER}" -eq 1 ]; then
              echo "➡ First stable build – updating stable deployment"
              TARGET_FILE="kubernetes/frontend/deployment.yaml"
            else
              echo "➡ Canary build – updating canary deployment"
              TARGET_FILE="kubernetes/frontend/canary-frontend.yaml"
            fi

            sed -i "s|image: tapashranjannandi/expense-tracker-frontend:.*|image: tapashranjannandi/expense-tracker-frontend:${BUILD_NUMBER}|" $TARGET_FILE

            git config user.email "tapash@gmail.com"
            git config user.name "Tapash"

            git add $TARGET_FILE
            git commit -m "Update frontend image to ${BUILD_NUMBER} (canary-aware)" || echo "No changes"
            git push origin master
          '''
        }
      }
    }
  }

  post {
    success {
      echo "✅ CI completed. Argo CD will handle stable/canary rollout."
    }
    failure {
      echo "❌ CI failed. Check Jenkins logs."
    }
  }
}

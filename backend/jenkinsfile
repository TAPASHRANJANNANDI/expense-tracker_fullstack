pipeline {
  agent any

  environment {
    DOCKER_IMAGE = "tapashranjannandi/expense-tracker-backend"
    DOCKER_TAG   = "${BUILD_NUMBER}"
    GITOPS_REPO  = "https://github.com/TAPASHRANJANNANDI/expense-tracker-fullstack-deployment.git"
  }

  stages {

    stage('Checkout Application Repo') {
      steps {
        git branch: 'master',
            url: 'https://github.com/TAPASHRANJANNANDI/expense-tracker_fullstack.git'
      }
    }

    stage('Build Docker Image') {
      steps {
        sh '''
          set -e
          docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
          docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
        '''
      }
    }

    stage('Push Docker Image') {
      steps {
        script {
          docker.withRegistry('https://index.docker.io/v1/', 'docker-cred') {
            docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}").push()
            docker.image("${DOCKER_IMAGE}:latest").push()
          }
        }
      }
    }

    stage('Update GitOps Repo (K8s Manifest)') {
      steps {
        withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
          sh '''
            set -e

            rm -rf gitops
            git clone https://${GITHUB_TOKEN}@github.com/TAPASHRANJANNANDI/expense-tracker-fullstack-deployment.git gitops
            cd gitops

            sed -i "s|image: tapashranjannandi/expense-tracker-backend:.*|image: tapashranjannandi/expense-tracker-backend:${BUILD_NUMBER}|" kubernetes/backend/deployment.yaml

            git config user.email "tapash@gmail.com"
            git config user.name "Tapash"

            git add kubernetes/backend/deployment.yaml
            git commit -m "Update backend image to ${BUILD_NUMBER}" || echo "No changes to commit"
            git push origin master
          '''
        }
      }
    }
  }

  post {
    success {
      echo "✅ CI completed. Argo CD will deploy automatically."
    }
    failure {
      echo "❌ CI failed. Check Jenkins logs."
    }
  }
}

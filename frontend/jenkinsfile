pipeline {
  agent any

  environment {
    DOCKER_IMAGE = "tapashranjannandi/expense-app-frontend"
    DOCKER_TAG   = "${BUILD_NUMBER}"
    DOCKER_LATEST = "latest"
    GITOPS_REPO  = "https://github.com/TAPASHRANJANNANDI/expense-tracker-fullstack-deployment.git"
    NODE_ENV     = "production"
  }

  options {
    buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '5'))
    timeout(time: 30, unit: 'MINUTES')
    timestamps()
  }

  stages {

    stage('Checkout') {
      steps {
        checkout(
          [
            $class: 'GitSCM',
            branches: [[name: '*/master']],
            userRemoteConfigs: [[url: 'https://github.com/TAPASHRANJANNANDI/expense-tracker_fullstack.git']]
          ]
        )
        echo "‚úÖ Source code checked out successfully"
      }
    }

    // stage('Build') {
    //   steps {
    //     dir('frontend') {
    //       sh '''
    //         echo "üì¶ Installing dependencies..."
    //         npm install
    //         echo "‚úÖ Dependencies installed"
    //       '''
    //     }
    //   }
    // }

    // stage('Lint') {
    //   steps {
    //     dir('frontend') {
    //       sh '''
    //         echo "üîç Running linter..."
    //         npm run lint || echo "‚ö†Ô∏è  Note: Add lint script to package.json when available"
    //       '''
    //     }
    //   }
    // }

    // stage('Build Application') {
    //   steps {
    //     dir('frontend') {
    //       sh '''
    //         echo "üèóÔ∏è  Building React application..."
    //         npm run build
    //         echo "‚úÖ Application built successfully"
    //       '''
    //     }
    //   }
    // }

    stage('Build Docker Image') {
      steps {
        dir('frontend') {
          sh '''
            echo "üê≥ Building Docker image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
            docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
            docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:${DOCKER_LATEST}
            echo "‚úÖ Docker image built successfully"
            docker images | grep ${DOCKER_IMAGE}
          '''
        }
      }
    }

    stage('Push Docker Image') {
      steps {
        script {
          docker.withRegistry('https://index.docker.io/v1/', 'docker-cred') {
            echo "üì§ Pushing image with tag: ${DOCKER_TAG}"
            docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}").push()
            echo "üì§ Pushing latest image"
            docker.image("${DOCKER_IMAGE}:${DOCKER_LATEST}").push()
            echo "‚úÖ Docker image pushed successfully"
          }
        }
      }
    }

    stage('Update GitOps Repo') {
      steps {
        withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
          sh '''
            set -e

            echo "üìù Updating GitOps repository..."
            rm -rf gitops

            git clone https://${GITHUB_TOKEN}@github.com/TAPASHRANJANNANDI/expense-tracker-fullstack-deployment.git gitops
            cd gitops

            # Update frontend deployment
            TARGET_FILE="kubernetes/frontend/deployment.yaml"

            if [ -f "$TARGET_FILE" ]; then
              echo "üîÑ Updating frontend image in: $TARGET_FILE"
              sed -i "s|image: tapashranjannandi/expense-app-frontend:.*|image: tapashranjannandi/expense-app-frontend:${DOCKER_TAG}|" "$TARGET_FILE"

              git config user.email "jenkins@tapash.dev"
              git config user.name "Jenkins CI"

              git add "$TARGET_FILE"
              git commit -m "ci: Update frontend image to ${DOCKER_TAG}" || echo "‚ö†Ô∏è  No changes to commit"
              git push origin main
              echo "‚úÖ GitOps repository updated"
            else
              echo "‚ö†Ô∏è  File not found: $TARGET_FILE"
            fi
          '''
        }
      }
    }
  }

  post {
    success {
      echo """
      ‚úÖ ================================
      ‚úÖ Frontend CI Pipeline Successful
      ‚úÖ ================================
      ‚úÖ Image: ${DOCKER_IMAGE}:${DOCKER_TAG}
      ‚úÖ GitOps deployment triggered
      """
    }
    failure {
      echo """
      ‚ùå ================================
      ‚ùå Frontend CI Pipeline Failed
      ‚ùå ================================
      ‚ùå Check Jenkins logs for details
      """
    }
    always {
      cleanWs()
    }
  }
}
